{% extends "layouts/admin_dashboard_content_base.html" %}
{% block title %}Billing ¬∑ Subscriptions{% endblock %}
{% block page_title %}Billing{% endblock %}
{% block hero_title %}All Subscriptions{% endblock %}
{% block hero_actions %}{% endblock %}
{% block hero_meta %}
  <div class="hero-text">Every user‚Äôs subscriptions. Filter by mode, status, or search.</div>
{% endblock %}

{% block page_content %}
  <form method="get" class="filters" style="margin: 0 0 12px 0; display:flex; gap:8px; flex-wrap:wrap;">
    <input type="text" name="q" value="{{ q or '' }}" placeholder="Search email / sub id / desc" style="min-width:240px;">
    <select name="mode">
      <option value="all"  {{ 'selected' if mode=='all'  else '' }}>All</option>
      <option value="live" {{ 'selected' if mode=='live' else '' }}>Live</option>
      <option value="test" {{ 'selected' if mode=='test' else '' }}>Test</option>
    </select>
    <input type="text" name="status" value="{{ status or '' }}" placeholder="Status (e.g., active)">
    <select name="per">
      {% for n in [25,50,100,200] %}
        <option value="{{n}}" {{ 'selected' if per==n else '' }}>{{n}} / page</option>
      {% endfor %}
    </select>
    <button type="submit" class="button">Apply</button>
  </form>

  {% if items and items.items %}
  <div class="table-wrap" style="overflow:auto;">
    <table class="orders-table" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="text-align:left; padding:8px;">Created</th>
          <th style="text-align:left; padding:8px;">User</th>
          <th style="text-align:left; padding:8px;">Subscription</th>
          <th style="text-align:left; padding:8px;">Description</th>
          <th style="text-align:right; padding:8px;">Amount</th>
          <th style="text-align:left; padding:8px;">Status</th>
          <th style="text-align:left; padding:8px;">Mode</th>
        </tr>
      </thead>
      <tbody>
        {% for rec, user in items.items %}
          <tr style="border-top:1px solid rgba(255,255,255,.08);">
            <td style="padding:8px;">{{ rec.created_at.strftime('%Y-%m-%d %H:%M') if rec.created_at else '-' }}</td>
            <td style="padding:8px;">{{ user.email }}</td>
            <td style="padding:8px;">{{ rec.subscription_id or rec.stripe_id }}</td>
            <td style="padding:8px;">{{ rec.description or '-' }}</td>
            <td style="padding:8px; text-align:right;">
              {% if rec.amount_cents is not none and rec.currency %}
                {{ '%.2f'|format(rec.amount_cents / 100.0) }} {{ rec.currency.upper() }}
              {% else %}-{% endif %}
            </td>
            <td style="padding:8px;">{{ rec.status or '-' }}</td>
            <td style="padding:8px;">
              <span class="mode-pill {{ 'live' if rec.livemode else 'test' }}" style="padding:2px 8px; border-radius:999px; font-size:12px; background:rgba(0,0,0,.15);">
                {{ 'Live' if rec.livemode else 'Test' }}
              </span>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="pagination" style="margin-top:12px; display:flex; gap:8px; align-items:center;">
    {% if items.page > 1 %}
      <a class="button" href="{{ url_for('admin_blueprint.admin_billing_subscriptions', q=q, mode=mode, status=status, page=items.page-1, per=per) }}">‚Äπ Prev</a>
    {% endif %}
    <span>Page {{ items.page }} / {{ items.pages or 1 }}</span>
    {% if items.page < (items.pages or 1) %}
      <a class="button" href="{{ url_for('admin_blueprint.admin_billing_subscriptions', q=q, mode=mode, status=status, page=items.page+1, per=per) }}">Next ‚Ä∫</a>
    {% endif %}
  </div>

  {% else %}
    <div class="empty-state">
      <div class="emoji">üóÉÔ∏è</div>
      <p class="empty-text">No subscriptions found.</p>
    </div>
  {% endif %}
{% endblock %}
