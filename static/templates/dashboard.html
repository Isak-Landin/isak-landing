{% extends "layouts/dashboard_content_base.html" %}

{% block page_title %}Your Dashboard{% endblock %}

{% block hero_title %}Your products{% endblock %}
{% block hero_actions %}{% endblock %}
{% block hero_meta %}
  <div class="hero-text">Fast, secure, and always in your control.</div>

  {% set awaiting_count = (vps_ctx.awaiting_provisioning.count
                           if vps_ctx is defined and vps_ctx.awaiting_provisioning is defined
                           else 0) %}
  <div class="trust-strip">
    <span class="trust-pill user-pill">ğŸ‘¤ {{ user.email }}</span>
    <span class="trust-pill">ğŸ’¬ Support chat ready</span>
    <span class="trust-pill">ğŸ–¥ï¸ {{ vps|length }} active server{{ '' if vps|length==1 else 's' }}</span>
    {% if awaiting_count > 0 %}
      <span class="trust-pill">â³ {{ awaiting_count }} awaiting provisioning</span>
    {% endif %}
  </div>
{% endblock %}

{% block page_content %}
<div class="dashboard-page">

  <div class="dashboard-summary">
    <div class="card">ğŸ–¥ï¸ <strong>{{ vps|length }}</strong> Servers</div>
    <div class="card">âš™ï¸ Active</div>
    <div class="card">ğŸ’¬ Chat Enabled</div>
    {% if vps_ctx is defined and vps_ctx.summary is defined %}
      <div class="card">â³ Awaiting: <strong>{{ vps_ctx.summary.awaiting_count }}</strong></div>
      <div class="card">ğŸ§Š Inactive: <strong>{{ vps_ctx.summary.inactive_count }}</strong></div>
    {% endif %}
  </div>

  {# ACTIVE â€” card-styled list #}
  {% if vps %}
    <h2 class="section-title">Active servers</h2>
    <ul class="split-list vps-list" role="list" aria-label="Active VPS">
      {% for server in vps %}
        {% set is_ready = (server.is_ready or server.provisioning_status == 'ready' or server.status == 'active') %}
        {% set badge_class =
              'badge--ready' if is_ready
              else ('badge--prov' if server.provisioning_status in ['provisioning','pending'] else 'badge--muted') %}
        {% set badge_label =
              'Ready' if is_ready
              else (server.provisioning_status|capitalize if server.provisioning_status else 'Pending') %}

        {# User detail URL (string literal path so we don't depend on endpoint names) #}
        {% set detail_url = '/vps/instance/' ~ server.id %}

        <li
          class="card-row"
          data-href="{{ url_for('vps_blueprint.vps_detail', vps_id=server.id) }}"
          role="link"
          tabindex="0"
          aria-label="Open {{ server.hostname }} details"
        >
          <span class="emoji" aria-hidden="true">ğŸ–¥ï¸</span>
          <span class="text">
            <span class="title">
              <strong>
                <a class="card-link" href="{{ url_for('vps_blueprint.vps_detail', vps_id=server.id) }}">
                  {{ server.hostname }}
                </a>
              </strong>
              â€” {{ server.ip_address }}
            </span>
            <span class="sub">OS: {{ server.os }} Â· CPU: {{ server.cpu_cores }} cores Â· RAM: {{ server.ram_mb }}MB</span>
          </span>
          <span class="spacer"></span>
          <span class="badge {{ badge_class }}">{{ badge_label }}</span>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="empty-state">
      <div class="emoji" aria-hidden="true">ğŸ›°ï¸</div>
      <p class="empty-text">You donâ€™t have any servers yet.</p>
      <a href="{{ url_for('vps_blueprint.vps_list_page') }}" class="button primary">Launch your first VPS</a>
    </div>
  {% endif %}

  {# AWAITING â€” card panel #}
  {% if vps_ctx is defined and vps_ctx.awaiting_provisioning is defined and vps_ctx.awaiting_provisioning.count > 0 %}
    <h2 class="section-title">Awaiting provisioning</h2>

    <section class="card-panel">
      <header class="card-head">
        <h3 class="title">Pending items</h3>
        <div class="meta">{{ vps_ctx.awaiting_provisioning.count }} total</div>
      </header>

      {% set subs_needing = vps_ctx.awaiting_provisioning.subs_needing_vps or [] %}
      {% set vps_progress = vps_ctx.awaiting_provisioning.vps_in_progress or [] %}

      {% if subs_needing %}
        <h3 class="subsection-title">Paid subscriptions (VPS not created yet)</h3>
        <ul class="card-list" role="list">
          {% for s in subs_needing %}
            <li class="card-item">
              <span class="emoji" aria-hidden="true">ğŸ§¾</span>
              <span class="text">
                <span class="title"><strong>Subscription {{ s.id }}</strong> â€” {{ s.plan_name or 'VPS plan' }}</span>
                <span class="sub">Status: {{ s.status }}{% if s.current_period_end %} Â· Renews: {{ s.current_period_end }}{% endif %}</span>
              </span>
              <span class="spacer"></span>
              <span class="badge badge--pending">Pending</span>
            </li>
          {% endfor %}
        </ul>
      {% endif %}

      {% if vps_progress %}
        <h3 class="subsection-title">Provisioning in progress</h3>
        <ul class="card-list" role="list">
          {% for s in vps_progress %}
            {% set prov = s.provisioning_status|default('pending') %}
            {% set cls = 'badge--prov' if prov in ['pending','provisioning'] else 'badge--ready' %}
            <li class="card-item">
              <span class="emoji" aria-hidden="true">â³</span>
              <span class="text">
                <span class="title"><strong>{{ s.hostname or 'Assigning hostnameâ€¦' }}</strong> â€” {{ s.ip_address or 'Pending IP' }}</span>
                <span class="sub">State: {{ prov }}{% if not s.is_ready %} Â· not ready{% endif %}</span>
              </span>
              <span class="spacer"></span>
              <span class="badge {{ cls }}">{{ prov }}</span>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </section>
  {% endif %}

  {# INACTIVE â€” card panel #}
  {% if vps_ctx is defined and vps_ctx.inactive_vps is defined and vps_ctx.inactive_vps|length > 0 %}
    <h2 class="section-title">Inactive servers</h2>
    <section class="card-panel">
      <header class="card-head">
        <h3 class="title">History</h3>
        <div class="meta">{{ vps_ctx.inactive_vps|length }} total</div>
      </header>

      <ul class="card-list" role="list">
        {% for s in vps_ctx.inactive_vps %}
          <li class="card-item">
            <span class="emoji" aria-hidden="true">ğŸ§Š</span>
            <span class="text">
              <span class="title"><strong>{{ s.hostname }}</strong>{% if s.ip_address %} â€” {{ s.ip_address }}{% endif %}</span>
              <span class="sub">Status: {{ s.status|capitalize }}{% if s.updated_at %} Â· Updated: {{ s.updated_at }}{% endif %}</span>
            </span>
            <span class="spacer"></span>
            <span class="badge badge--inactive">Inactive</span>
          </li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}

</div>
{% endblock %}

{% block extra_css %}{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}?v=10">
{% endblock %}
{% block extra_js %}{{ super() }}
<script src="{{ url_for('static', filename='js/users/dashboard_card_nav.js') }}?v=2" defer></script>
{% endblock %}
