{% extends "layouts/dashboard_content_base.html" %}

{% block page_title %}Your Dashboard{% endblock %}

{% block hero_title %}Your products{% endblock %}
{% block hero_actions %}{% endblock %}
{% block hero_meta %}
  <div class="hero-text">Fast, secure, and always in your control.</div>

  {% set awaiting_count = (vps_ctx.awaiting_provisioning.count
                           if vps_ctx is defined and vps_ctx.awaiting_provisioning is defined
                           else 0) %}
  <div class="trust-strip">
    <span class="trust-pill user-pill">ğŸ‘¤ {{ user.email }}</span>
    <span class="trust-pill">ğŸ’¬ Support chat ready</span>
    <span class="trust-pill">ğŸ–¥ï¸ {{ vps|length }} active server{{ '' if vps|length==1 else 's' }}</span>
    {% if awaiting_count > 0 %}
      <span class="trust-pill">â³ {{ awaiting_count }} awaiting provisioning</span>
    {% endif %}
  </div>
{% endblock %}

{% block page_content %}

  <div class="dashboard-summary">
    <div class="card">ğŸ–¥ï¸ <strong>{{ vps|length }}</strong> Servers</div>
    <div class="card">âš™ï¸ Active</div>
    <div class="card">ğŸ’¬ Chat Enabled</div>
    {% if vps_ctx is defined and vps_ctx.summary is defined %}
      <div class="card">â³ Awaiting: <strong>{{ vps_ctx.summary.awaiting_count }}</strong></div>
      <div class="card">ğŸ§Š Inactive: <strong>{{ vps_ctx.summary.inactive_count }}</strong></div>
    {% endif %}
  </div>

  {# ACTIVE â€” unchanged markup; now gets card look via .split-list styles #}
  {% if vps %}
    <h2 class="section-title">Active servers</h2>
    <ul class="split-list">
      {% for server in vps %}
        <li>
          <span class="emoji">ğŸ–¥ï¸</span>
          <span class="text">
            <strong>{{ server.hostname }}</strong> â€“ {{ server.ip_address }}<br>
            <span class="sub">OS: {{ server.os }} | CPU: {{ server.cpu_cores }} cores | RAM: {{ server.ram_mb }}MB</span>
          </span>
          <span class="badge ready" style="margin-left:auto">ready</span>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="empty-state">
      <div class="emoji">ğŸ›°ï¸</div>
      <p class="empty-text">You donâ€™t have any servers yet.</p>
      <a href="{{ url_for('vps_blueprint.vps_list_page') }}" class="button primary">Launch your first VPS</a>
    </div>
  {% endif %}

  {# AWAITING â€” wrap in a card-panel #}
  {% if vps_ctx is defined and vps_ctx.awaiting_provisioning is defined and vps_ctx.awaiting_provisioning.count > 0 %}
    <h2 class="section-title">Awaiting provisioning</h2>

    <div class="card-panel">
      <div class="card-head">
        <h3 class="title">Pending items</h3>
        <div class="meta">{{ vps_ctx.awaiting_provisioning.count }} total</div>
      </div>

      {% set subs_needing = vps_ctx.awaiting_provisioning.subs_needing_vps or [] %}
      {% set vps_progress = vps_ctx.awaiting_provisioning.vps_in_progress or [] %}

      {% if subs_needing %}
        <h3 class="subsection-title">Paid subscriptions (VPS not created yet)</h3>
        <ul class="card-list">
          {% for s in subs_needing %}
            <li class="card-item">
              <span class="emoji">ğŸ§¾</span>
              <span class="text">
                <strong>Subscription {{ s.id }}</strong> â€” {{ s.plan_name or 'VPS plan' }}<br>
                <span class="sub">Status: {{ s.status }}{% if s.current_period_end %} Â· Renews: {{ s.current_period_end }}{% endif %}</span>
              </span>
              <span class="badge pending" style="margin-left:auto">pending</span>
            </li>
          {% endfor %}
        </ul>
      {% endif %}

      {% if vps_progress %}
        <h3 class="subsection-title" style="margin-top:10px;">Provisioning in progress</h3>
        <ul class="card-list">
          {% for s in vps_progress %}
            <li class="card-item">
              <span class="emoji">â³</span>
              <span class="text">
                <strong>{{ s.hostname or 'Assigning hostnameâ€¦' }}</strong>
                â€” {{ s.ip_address or 'Pending IP' }}<br>
                <span class="sub">State: {{ s.provisioning_status|default('pending') }}{% if not s.is_ready %} Â· not ready{% endif %}</span>
              </span>
              <span class="badge provisioning" style="margin-left:auto">
                {{ s.provisioning_status|default('pending') }}
              </span>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>
  {% endif %}

  {# INACTIVE â€” wrap in card-panel #}
  {% if vps_ctx is defined and vps_ctx.inactive_vps is defined and vps_ctx.inactive_vps|length > 0 %}
    <h2 class="section-title">Inactive servers</h2>
    <div class="card-panel">
      <div class="card-head">
        <h3 class="title">History</h3>
        <div class="meta">{{ vps_ctx.inactive_vps|length }} total</div>
      </div>
      <ul class="card-list">
        {% for s in vps_ctx.inactive_vps %}
          <li class="card-item">
            <span class="emoji">ğŸ§Š</span>
            <span class="text">
              <strong>{{ s.hostname }}</strong>{% if s.ip_address %} â€” {{ s.ip_address }}{% endif %}<br>
              <span class="sub">Status: {{ s.status|capitalize }}{% if s.updated_at %} Â· Updated: {{ s.updated_at }}{% endif %}</span>
            </span>
            <span class="badge inactive" style="margin-left:auto">inactive</span>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

{% endblock %}

{% block extra_css %}{{ super() }}
<script src="{{ url_for('static', filename='css/user/dashboard.css') }}"></script>
{% endblock %}
{% block extra_js %}{{ super() }}{% endblock %}
